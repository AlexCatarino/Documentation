<p>
 The following examples demonstrate some common practices for consolidator history.
</p>
<h4>
 Example 1: Price Action
</h4>
<p>
 The following algorithm trades breakout price action on the SPY five-minute trade bar. To do so, we must create a five-minute trade bar consolidator and a rolling window to hold 3 trade bars to check if the trade conditions are fulfilled.
</p>
<div class="section-example-container testable">
 <pre class="csharp">public class ConsolidatorHistoryAlgorithm : QCAlgorithm
{
    private Symbol _spy;
    // To hold 3 consolidated trade bars to identify a breakout pattern.
    private RollingWindow&lt;TradeBar&gt; _windows = new(3);

    public override void Initialize()
    {
        SetStartDate(2024, 9, 1);
        SetEndDate(2024, 12, 31);
        
        // Request SPY data for signal generation and trading.
        _spy = AddEquity("SPY", Resolution.Minute).Symbol;

        // The breakout is based on a 5-minute consolidated trade bar.
        var consolidator = new TradeBarConsolidator(TimeSpan.FromMinutes(5));
        // Subscribe for automatically updating the consolidator with SPY data.
        SubscriptionManager.AddConsolidator(_spy, consolidator);
        // Add a consolidator handler to check that the breakout condition is fulfilled and traded.
        consolidator.DataConsolidated += OnConsolidated;

        SetWarmUp(TimeSpan.FromDays(1));
    }

    private void OnConsolidated(object sender, TradeBar bar)
    {
        _windows.Add(bar);

        if (!IsWarmingUp &amp;&amp; _windows.IsReady)
        {
            // Buy if the breakout price action is fulfilled.
            // 1. Increasing price trend.
            // 2. The last 3 bars are green.
            // 3. The 3rd and 2nd last bars range is decreasing.
            // 4. The last bar exceeds the 2nd last bar by double the 2nd last bar's range.
            var secondLastRange = _windows[1].Close - _windows[1].Open;
            if (bar.Close &gt; _windows[1].Close &amp;&amp; _windows[1].Close &gt; _windows[2].Close &amp;&amp;
            _windows[2].Close &gt; _windows[2].Open &amp;&amp; _windows[1].Close &gt; _windows[1].Open &amp;&amp; _windows[0].Close &gt; _windows[0].Open &amp;&amp;
            _windows[2].Close - _windows[2].Open &gt; secondLastRange &amp;&amp; bar.Close &gt; _windows[1].Close + 2 * secondLastRange)
            {
                SetHoldings(_spy, 0.5m);
            }
        }
    }

    public override void OnOrderEvent(OrderEvent orderEvent)
    {
        if (orderEvent.Status == OrderStatus.Filled)
        {
            if (orderEvent.Ticket.OrderType == OrderType.Market)
            {
                // Stop loss order at 1%.
                var stopPrice = orderEvent.FillQuantity &gt; 0m ? orderEvent.FillPrice * 0.99m : orderEvent.FillPrice * 1.01m;
                StopMarketOrder(_spy, -Portfolio[_spy].Quantity, stopPrice);
                // Take profit order at 2%.
                var takeProfitPrice = orderEvent.FillQuantity &gt; 0m ? orderEvent.FillPrice * 1.02m : orderEvent.FillPrice * 0.98m;
                LimitOrder(_spy, -Portfolio[_spy].Quantity, takeProfitPrice);
            }
            else if (orderEvent.Ticket.OrderType == OrderType.StopMarket || orderEvent.Ticket.OrderType == OrderType.Limit)
            {
                // Cancel any open order if stop loss or take profit order filled.
                Transactions.CancelOpenOrders();
            }
        }
    }
}</pre>
 <script class="csharp-result" type="text">
  {
    "Total Orders": "60",
    "Average Win": "0.71%",
    "Average Loss": "-0.52%",
    "Compounding Annual Return": "4.722%",
    "Drawdown": "2.100%",
    "Expectancy": "0.180",
    "Start Equity": "100000",
    "End Equity": "101550.45",
    "Net Profit": "1.550%",
    "Sharpe Ratio": "-0.5",
    "Sortino Ratio": "-0.584",
    "Probabilistic Sharpe Ratio": "43.602%",
    "Loss Rate": "50%",
    "Win Rate": "50%",
    "Profit-Loss Ratio": "1.36",
    "Alpha": "-0.038",
    "Beta": "0.33",
    "Annual Standard Deviation": "0.043",
    "Annual Variance": "0.002",
    "Information Ratio": "-0.952",
    "Tracking Error": "0.075",
    "Treynor Ratio": "-0.065",
    "Total Fees": "$38.00",
    "Estimated Strategy Capacity": "$47000000.00",
    "Lowest Capacity Asset": "SPY R735QTJ8XC9X",
    "Portfolio Turnover": "15.05%",
    "Drawdown Recovery": "22",
    "OrderListHash": "57b28be669d783c0f3ccda4444171a3c"
}
 </script>
 <pre class="python">class ConsolidatorHistoryAlgorithm(QCAlgorithm):
    # To hold 3 consolidated trade bars to identify a breakout pattern.
    windows = RollingWindow(3)

    def initialize(self) -&gt; None:
        self.set_start_date(2024, 9, 1)
        self.set_end_date(2024, 12, 31)
        
        # Request SPY data for signal generation and trading.
        self.spy = self.add_equity("SPY", Resolution.MINUTE).symbol

        # The breakout is based on a 5-minute consolidated trade bar.
        consolidator = TradeBarConsolidator(timedelta(minutes=5))
        # Subscribe for automatically updating the consolidator with SPY data.
        self.subscription_manager.add_consolidator(self.spy, consolidator)
        # Add a consolidator handler to check that the breakout condition is fulfilled and traded.
        consolidator.data_consolidated += self.on_consolidated

        self.set_warm_up(timedelta(15))

    def on_consolidated(self, sender: object, bar: TradeBar) -&gt; None:
        self.windows.add(bar)

        if not self.is_warming_up and self.windows.is_ready:
            # Buy if the breakout price action is fulfilled.
            # 1. Increasing price trend.
            # 2. The last 3 bars are green.
            # 3. The 3rd and 2nd last bars range is decreasing.
            # 4. The last bar exceeds the 2nd last bar by double the 2nd last bar's range.
            second_last_range = self.windows[1].close - self.windows[1].open
            if bar.close &gt; self.windows[1].close and self.windows[1].close &gt; self.windows[2].close and\
            self.windows[2].close &gt; self.windows[2].open and self.windows[1].close &gt; self.windows[1].open and\
            self.windows[0].close &gt; self.windows[0].open and self.windows[2].close - self.windows[2].open &gt; second_last_range and\
            bar.close &gt; self.windows[1].close + 2 * second_last_range:
                self.set_holdings(self.spy, 0.5)

    def on_order_event(self, order_event: OrderEvent) -&gt; None:
        if order_event.status == OrderStatus.FILLED:
            if order_event.ticket.order_type == OrderType.MARKET:
                # Stop loss order at 1%.
                stop_price = order_event.fill_price * 0.99 if order_event.fill_quantity &gt; 0 else order_event.fill_price * 1.01
                self.stop_market_order(self.spy, -self.portfolio[self.spy].quantity, stop_price)
                # Take profit order at 2%.
                take_profit_price = order_event.fill_price * 1.02 if order_event.fill_quantity &gt; 0 else order_event.fill_price * 0.98
                self.limit_order(self.spy, -self.portfolio[self.spy].quantity, take_profit_price)
            elif order_event.ticket.order_type == OrderType.STOP_MARKET or order_event.ticket.order_type == OrderType.LIMIT:
                # Cancel any open order if stop loss or take profit order filled.
                self.transactions.cancel_open_orders()</pre>
 <script class="python-result" type="text">
  {
    "Total Orders": "60",
    "Average Win": "0.71%",
    "Average Loss": "-0.52%",
    "Compounding Annual Return": "4.741%",
    "Drawdown": "2.100%",
    "Expectancy": "0.180",
    "Start Equity": "100000",
    "End Equity": "101556.53",
    "Net Profit": "1.557%",
    "Sharpe Ratio": "-0.497",
    "Sortino Ratio": "-0.582",
    "Probabilistic Sharpe Ratio": "43.693%",
    "Loss Rate": "50%",
    "Win Rate": "50%",
    "Profit-Loss Ratio": "1.36",
    "Alpha": "-0.038",
    "Beta": "0.329",
    "Annual Standard Deviation": "0.043",
    "Annual Variance": "0.002",
    "Information Ratio": "-0.95",
    "Tracking Error": "0.075",
    "Treynor Ratio": "-0.065",
    "Total Fees": "$38.00",
    "Estimated Strategy Capacity": "$47000000.00",
    "Lowest Capacity Asset": "SPY R735QTJ8XC9X",
    "Portfolio Turnover": "15.05%",
    "Drawdown Recovery": "22",
    "OrderListHash": "e18b546950205a8be8b357dac38288f5"
}
 </script>
</div>
