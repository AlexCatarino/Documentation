<p>
 The following examples demonstrate some common practices for implementing the settlement model.
</p>
<h4>
 Example 1: 2-day Settlement
</h4>
<p>
 The following algorithm simulates
 <a href="https://qnt.co/interactivebrokers" rel="nofollow" target="_blank">
  Interactive Brokers
 </a>
 cash account. According to IB's website, cash positions will be settled in 48 hours. Thus, we can implement
 <code>
  DelayedSettlementModel
 </code>
 to mimic that. We hold the intra-day position of SPY to implement the settlement logic.
</p>
<div class="section-example-container testable">
 <pre class="csharp">public class SettlementModelAlgorithm : QCAlgorithm
{
    private Symbol _spy;

    public override void Initialize()
    {
        SetStartDate(2024, 9, 1);
        SetEndDate(2024, 12, 31);

        // Simulate a cash account of IB.
        SetBrokerageModel(BrokerageName.InteractiveBrokersBrokerage, AccountType.Cash);
        // We need to set the settlement model in the security initializer.
        SetSecurityInitializer(new CustomSecurityInitializer(BrokerageModel, SecuritySeeder.Null));

        // Request SPY data for trading.
        _spy = AddEquity("SPY").Symbol;
    }

    public override void OnData(Slice slice)
    {
        // Trade based on updated data.
        if (slice.QuoteBars.TryGetValue(_spy, out var bar) &amp;&amp; !Portfolio.Invested)
        {
            // Order based on the current available cash.
            var quantity = Math.Floor((Portfolio.Cash - Portfolio.UnsettledCash) / bar.Ask.Close);
            if (quantity &gt; 0)
            {
                MarketOrder(_spy, quantity);
            }
        }

        // Exit position before market close; we only hold the intraday position.
        if (slice.Time.Hour == 15 &amp;&amp; slice.Time.Minute == 45)
        {
            Liquidate();
        }
    }
}

class CustomSecurityInitializer : BrokerageModelSecurityInitializer
{
    public CustomSecurityInitializer(IBrokerageModel brokerageModel, ISecuritySeeder securitySeeder)
        : base(brokerageModel, securitySeeder)
    {

    }
    public override void Initialize(Security security)
    {
        base.Initialize(security);
        // IB settles cash in 48 hours.
        security.SetSettlementModel(new DelayedSettlementModel(2, new TimeSpan(0, 0, 0)));
    }
}</pre>
 <script class="csharp-result" type="text">
  {
    "Total Orders": "82",
    "Average Win": "0.50%",
    "Average Loss": "-0.61%",
    "Compounding Annual Return": "-11.346%",
    "Drawdown": "6.900%",
    "Expectancy": "-0.157",
    "Start Equity": "100000",
    "End Equity": "96064.01",
    "Net Profit": "-3.936%",
    "Sharpe Ratio": "-1.902",
    "Sortino Ratio": "-1.364",
    "Probabilistic Sharpe Ratio": "5.492%",
    "Loss Rate": "54%",
    "Win Rate": "46%",
    "Profit-Loss Ratio": "0.82",
    "Alpha": "0",
    "Beta": "0",
    "Annual Standard Deviation": "0.07",
    "Annual Variance": "0.005",
    "Information Ratio": "-1.115",
    "Tracking Error": "0.07",
    "Treynor Ratio": "0",
    "Total Fees": "$82.00",
    "Estimated Strategy Capacity": "$55000000.00",
    "Lowest Capacity Asset": "SPY R735QTJ8XC9X",
    "Portfolio Turnover": "67.03%",
    "Drawdown Recovery": "0",
    "OrderListHash": "12674a44c81e1cb19d337ee6848dc4c6"
}
 </script>
 <pre class="python"># region imports
from AlgorithmImports import *
# endregion

class SettlementModelAlgorithm(QCAlgorithm):
    def initialize(self) -&gt; None:
        self.set_start_date(2024, 9, 1)
        self.set_end_date(2024, 12, 31)
        
        # Simulate a cash account of IB.
        self.set_brokerage_model(BrokerageName.INTERACTIVE_BROKERS_BROKERAGE, AccountType.CASH)
        # We need to set the settlement model in the security initializer.
        self.set_security_initializer(CustomSecurityInitializer(self.brokerage_model, SecuritySeeder.NULL))

        # Request SPY data for trading.
        self.spy = self.add_equity("SPY").symbol

    def on_data(self, slice: Slice) -&gt; None:
        # Trade based on updated data.
        bar = slice.quote_bars.get(self.spy)
        if bar and not self.portfolio.invested:
            # Order based on the current available cash.
            quantity = (self.portfolio.cash - self.portfolio.unsettled_cash) //  bar.ask.close
            if quantity &gt; 0:
                self.market_order(self.spy, quantity)
        
        # Exit position before market close; we only hold the intraday position.
        if slice.time.hour == 15 and slice.time.minute == 45:
            self.liquidate()

class CustomSecurityInitializer(BrokerageModelSecurityInitializer):
    def __init__(self, brokerage_model: IBrokerageModel, security_seeder: ISecuritySeeder):
        super().__init__(brokerage_model, security_seeder)
    def initialize(self, security: Security) -&gt; None:
        super().initialize(security)
        # IB settles cash in 48 hours.
        security.set_settlement_model(DelayedSettlementModel(2, timedelta(hours=0)))</pre>
 <script class="python-result" type="text">
  {
    "Total Orders": "82",
    "Average Win": "0.50%",
    "Average Loss": "-0.61%",
    "Compounding Annual Return": "-11.346%",
    "Drawdown": "6.900%",
    "Expectancy": "-0.157",
    "Start Equity": "100000",
    "End Equity": "96064.01",
    "Net Profit": "-3.936%",
    "Sharpe Ratio": "-1.902",
    "Sortino Ratio": "-1.364",
    "Probabilistic Sharpe Ratio": "5.492%",
    "Loss Rate": "54%",
    "Win Rate": "46%",
    "Profit-Loss Ratio": "0.82",
    "Alpha": "0",
    "Beta": "0",
    "Annual Standard Deviation": "0.07",
    "Annual Variance": "0.005",
    "Information Ratio": "-1.115",
    "Tracking Error": "0.07",
    "Treynor Ratio": "0",
    "Total Fees": "$82.00",
    "Estimated Strategy Capacity": "$55000000.00",
    "Lowest Capacity Asset": "SPY R735QTJ8XC9X",
    "Portfolio Turnover": "67.03%",
    "Drawdown Recovery": "0",
    "OrderListHash": "12674a44c81e1cb19d337ee6848dc4c6"
}
 </script>
</div>


<h4>
 Example 2: No Unsettled Cash
</h4>
<p>
 The following algorithm implements a custom settlement model that states there is always $0 of unsettled cash.
</p>

<div class="section-example-container testable testable">
 <pre class="csharp">public class CustomSettlementModelAlgorithm : QCAlgorithm
{
    private bool _traded;

    public override void Initialize()
    {
        SetStartDate(2024, 9, 1);
        SetEndDate(2024, 12, 31);
        SetCash(100000);

        var security = AddEquity("SPY");
        security.SetSettlementModel(new MySettlementModel());

        Schedule.On(
            DateRules.EveryDay("SPY"),
            TimeRules.Every(TimeSpan.FromMinutes(30)),
            plotCash
        );

        _traded = false;
    }

    private void plotCash()
    {
        Plot("Settled Cash", "USD", Portfolio.CashBook["USD"].Amount);
        Plot("Unsettled Cash", "USD", Portfolio.UnsettledCashBook["USD"].Amount);
    }

    public override void OnData(Slice data)
    {
        if (_traded)
            return;

        MarketOrder("SPY", 1);
        MarketOrder("SPY", -1);
        _traded = true;
    }
}

public class MySettlementModel : ISettlementModel
{
    public void ApplyFunds(ApplyFundsSettlementModelParameters applyFundsParameters)
    {
        var currency = applyFundsParameters.CashAmount.Currency;
        var amount = applyFundsParameters.CashAmount.Amount;
        applyFundsParameters.Portfolio.CashBook[currency].AddAmount(amount);
    }

    public void Scan(ScanSettlementModelParameters settlementParameters)
    {
    }
    
    public CashAmount GetUnsettledCash()
    {
        return new CashAmount(0, "USD");
    }
}</pre>
 <script class="csharp-result" type="text">
  {}
 </script>
 <pre class="python">class CustomSettlementModelAlgorithm(QCAlgorithm):

    def initialize(self) -> None:
        self.set_start_date(2024, 9, 1)
        self.set_end_date(2024, 12, 31)
        self.set_cash(100000)
        
        security = self.add_equity('SPY')
        security.set_settlement_model(MySettlementModel())

        self.schedule.on(
            self.date_rules.every_day('SPY'),
            self.time_rules.every(timedelta(minutes=30)),
            self._plot_cash
        )

        self._traded = False

    def _plot_cash(self):
        self.Plot("Settled Cash", "USD", self.Portfolio.CashBook["USD"].Amount)
        self.Plot("Unsettled Cash", "USD", self.Portfolio.UnsettledCashBook["USD"].Amount)

    def on_data(self, data: Slice) -> None:
        if self._traded:
            return

        self.market_order('SPY', 1)
        self.market_order('SPY', -1)
        self._traded = True


class MySettlementModel:
    
    def apply_funds(self, apply_funds_parameters: ApplyFundsSettlementModelParameters) -> None:
        currency = apply_funds_parameters.cash_amount.currency
        amount = apply_funds_parameters.cash_amount.amount
        apply_funds_parameters.portfolio.cash_book[currency].add_amount(amount)

    def scan(self, settlement_parameters: ScanSettlementModelParameters) -> None:
        pass

    def get_unsettled_cash(self) -> CashAmount:
        return CashAmount(0, 'USD')</pre>
 <script class="python-result" type="text">
  {}
 </script>
</div>
